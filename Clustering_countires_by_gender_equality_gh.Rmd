---
title: "Clustering Countries by Gender Inequality"
author: "Andre Stephens"
output: 
  github_document:
    css: mystyle.css
    toc: true
---

# Examining the Data

## Setup

We will load required packages. 
```{r message=FALSE, warning=FALSE}
# required packages
library(xtable)
library(car)
library(corrplot)
library(cluster)
library(fpc)
library(pastecs)
library(dendextend)
library(circlize)
set.seed(123)
```

## Descriptives

The data consist of gender inequality-related variables from 146 countries presented in the 2012 UN Human Development Report.

```{r}
# import data file
gender  <-  read.csv("gender_data.csv",header=TRUE)  #import csv file
rownames(gender) <- gender$Country
gender <- gender[-c(1)]
names(gender) <- c("GII.rank", "GII.val", "Mat.mort.ratio", "Ado.fert.rate","pct.parl.seats.Fem", "pct.sec.ed.Fem", "pct.sec.ed.Male", "labor.force.part.Fem", "labor.force.part.Male", "pct.contracept", "pct.antenatal.care", "pct.birth.by.prof", "Tot.fert.rate")
head(gender)
```

The dataset include these variables:

```{r echo=FALSE, results='asis'}
writeLines("td, th { padding : 6px } th { background-color : blue ; color : white; border : 1px solid white; } td { color : blue ; border : 1px solid blue }", con = "mystyle.css")

col1 <- names(gender)
col2 <- c("Gender Inequality ranking","Gender Inequality value","Maternal Mortality Rate","Adolescent Fertility Rate","Percent of Female-Held Parliament Seats","Percent of Females with a Secondary Education","Percent of Males with a Secondary Education","Percent of Working-Age Females in the Labour Force","Percent of Working-Age Males in the Labour Force","Percent of Individuals with Access to Contraception","Percent of Pregnant Women Receiving Antenatal Care (at least one visit)","Percent of Births Involving Skilled Professional","Total Fertility Rate")
tab <- data.frame(Variable_Code=col1, Variable_Name=col2)

knitr::kable(tab, format = "html")
```

Here are some summary stats. 

```{r}
summary(gender)
```

*There is a lot of missingness in the antenatal care column, so we will drop this variable later.*

## Simple Diagnostics

### Correlation Analysis

We can use Pearson's r to determine the degree of correlations across variables.

```{r}
corrmatrix <- cor(gender, use = "pairwise.complete.obs")
round(corrmatrix, 2)
```

```{r}
corrplot(corrmatrix, method = "circle") #plot matrix
```

The visualization above represents the degree of the correlation of our gender inequality-related variables. The  results  suggest that the percent of females receiving post-secondary education is nearly perfectly correlated (r=0.94) with the percent of males. The gender inequality index (GII) rank is also perfectly correlated with the GII value due to the fact that the rank is simply a function of value. The correlation matrix below provides further confirmation of this.

The correlations suggest a number of interesting trends in this data.

* Adolescent fertility is highly positively correlated with total fertility, suggesting that much of a country's birth rate relative to others can be explained by the birth rate among adolescents
* Maternal mortality rate is highly positivelycorrelated with total/adolescent fertility, suggesting that countries with higher birth rates also tend to have higher numbers of maternal deaths
* Maternal mortality rates also tend to be lower in countries where skilled professionals are involved in delivery (pct.birth.prof) and where access to contraception (pct.contracept) is higher
* The percentage of females and males who receive at least a secondary education is strongly negatively correlated with total fertility and positively correlated with percentage births involving skilled professionals, implying that countries where women are highly educated tend to have lower birth rates and higher rates of professional care during childbirth. It is notable that these correlations are slightly stronger for higher rates of educated females than males.

*Note that these do not imply any causation.*


### Bivariate Plot Analysis

Excluding one of the highly-correlated variables and a few variables with low correlations (pct.parl.seats.Fem, labor.force.part.Fem), we can produce a scatterplot matrix of bivariate plots with fitted lines.

```{r}
#scatterplot
formula <- ~Mat.mort.ratio+Ado.fert.rate+pct.sec.ed.Fem+labor.force.part.Fem+labor.force.part.Male+pct.contracept+pct.antenatal.care+pct.birth.by.prof+Tot.fert.rate
scatterplotMatrix(formula, upper.panel=panel.smooth, lwd=3, regLine = list(method=MASS::rlm, col="red", lwd=3), data=gender, main="Scatterplot Matrix of Gender Inequality Variables") 
```

The fitted regression lines (smoothed lines shown in black-dotted plots) also indicate some interesting trends:

* Total fertility rate grows exponentially with the labour force participation of men, suggesting that birth rates tend to grow a lot faster for countries where many working-age males are in the labour force as opposed to countries with fewer men in the labour force.

```{r}
scatter.smooth(gender$Tot.fert.rate~gender$labor.force.part.Male, lpars=list(col="red", lwd=2), pch=3, col="darkgrey", ylab="Total Fertility Rate", xlab="Male Labour Force Participation")

sampled <- gender[sample(nrow(gender), 10), ]
text(sampled$Tot.fert.rate~sampled$labor.force.part.Male, labels=rownames(sampled), cex=0.7, font=2)
```

* Maternal mortality grows exponentially with rise in labour force participation of women. This means that, that for countries with low female participation in the labour force, further increases in participation among women tend to have a relatively small effect on maternal deaths during childbirth. However, countries with high rates of female participation tend to see a much larger increase in maternal mortality when more women enter the workforce.

```{r}
scatter.smooth(gender$Mat.mort.ratio~gender$labor.force.part.Fem, lpars=list(col="red", lwd=2), pch=3, col="darkgrey", ylab="Maternal Mortality Rate", xlab="Female Labour Force Participation")

sampled <- gender[sample(nrow(gender), 15), ]
text(sampled$Mat.mort.ratio~sampled$labor.force.part.Fem, labels=rownames(sampled), cex=0.7, font=2)
```

* On the other hand, total fertility and adolescent fertility rates decay exponentially for countries with higher numbers of males and females with a secondary education. In other words, countries with a more educated population will tend to be associated with a more significant drop in birth rates as more people acquire education.

```{r}
scatter.smooth(gender$Tot.fert.rate~gender$pct.sec.ed.Fem, lpars=list(col="red", lwd=2), pch=3, col="darkgrey", ylab="Total Fertility Rate", xlab="Percent Female with Secondary Education")

sampled <- gender[sample(nrow(gender), 15), ]
text(sampled$Tot.fert.rate~sampled$pct.sec.ed.Fem, labels=rownames(sampled), cex=0.7, font=2)
```

* Finally, the association between total fertility and female labour force participation appears somewhat U-shaped. This implies that, for countires with low participation, more women entering the workforce tends to correlate with a relatively sharp decline in fertility whereas more women entering in a country with high participation tends to lead to a sharp increase in fertility.

```{r}
scatter.smooth(gender$Tot.fert.rate~gender$labor.force.part.Fem, lpars=list(col="red", lwd=2), pch=3, col="darkgrey", ylab="Total Fertility Rate", xlab="Female Labour Force Participation")

sampled <- gender[sample(nrow(gender), 15), ]
text(sampled$Tot.fert.rate~sampled$labor.force.part.Fem, labels=rownames(sampled), cex=0.7, font=2)
```

*Note that these do not imply any causation.*

# Clustering

We want to cluster the data to see if countries match distinct groups based on gender inequality metrics.

```{r}
#subset data excluding UN index and antenatal care because of missingness
gender.subset <- subset(gender, select=-c(GII.rank,GII.val,pct.antenatal.care)) 
# standardize variables for comparability
gender.scaled <- scale(na.omit(gender.subset))
```

## K-means Clustering

### Determining k

We will determine the optimal number of clusters using the Elbow and Gap Statistic methods.

#### Elbow Method

```{r}
# Elbow method
set.seed(123)
# compute and plot wss for k = 2 to k = 16
k.max <- 15 # Maximal number of clusters

wss_func <- function(k){
  kmeans(gender.scaled, centers=k)$tot.withinss
}

within.sums <- sapply(1:k.max, wss_func)



plot(1:k.max, within.sums, type="b", 
      xlab="Number of clusters (k)",
      ylab="Within groups sum of squares",  
      main="Elbow Method for Determining K")
abline(v = 3, lty =2, col="red")
```

The results suggest that most of the within-group sum of squares is reduced at k=3.

#### Gap Statistic

```{r}
# Compute gap statistic
gap_stat <- clusGap(gender.scaled, FUN=kmeans, K.max = k.max)

# Base plot of gap statistic
plot(gap_stat, frame = FALSE, xlab = "Number of clusters (k)",
     main="Gap Statistics Method for Determining K")
abline(v = 3, lty = 2)

```

The gap statistic method suggests we choose k such that $Gap(k) \geq Gap(k+1) - se_{k+1}$ using Tibshirani et al.'s (2001) suggestion.

```{r}
print(gap_stat, method = "Tibs2001SEmax")
```
These results confirm an optimal k of 3.

### Model

Using the `kmeans` function to cluster our gender data.
```{r}
# generate clusters 
km <- kmeans(gender.scaled, 3, iter.max=1000000)

# plot solution 
clusplot(gender.scaled, km$cluster, color=TRUE, shade=TRUE, labels=2, cex.txt=0.35, cex=0, lines=0, 
         main="Gender Inequality Clusters (Country-level)")
```

## Kernel Density Estimation

We are interested in comparing how our k-means clusters assigns countries to groups based on gender-inequality-related variables as opposed to the Gender Inequality Index.

We will use Kernel Density Estimation for the univariate grouping of countries based on the GII. 
```{r warning=FALSE}
# gii variable
gii <- na.omit(gender$GII.val)
# generate kde
kde <- density(gii, bw="SJ", from=0, to=0.8)#, adjust=0.9)

#calculate extrema
tp <- turnpoints(kde$y)

#plot
plot(kde, main="Kernel Density of Gender Inequality Index")
points(kde$x[tp$tppos],kde$y[tp$tppos],col=c("red","white","red"),pch=19)
abline(v=kde$x[tp$pits], col="red")
```

The estimation uses the recommended Sheather-Jones method for choosing bandwidth gives two local maxima and a local minimum. This suggests that the data can be reasonably classified into distinct groups. However, notice a slight dip in the density smooting at around x = 0.4 which might indicate a second minimum point for a narrower bandwith.

```{r warning=FALSE}
# generate kde with reduced bw
kde.rbw <- density(gii, bw="SJ", from=0, to=0.8, adjust=0.9)

#calculate extrema
tp.rbw <- turnpoints(kde.rbw$y)

#plot
plot(kde.rbw, main="Kernel Density of Gender Inequality Index (adj=0.9)")
points(kde.rbw$x[tp.rbw$tppos],
       kde.rbw$y[tp.rbw$tppos],
       col=c("red","white","red","white","red"),pch=19)
abline(v=kde.rbw$x[tp.rbw$pits], col="red")
```

With just a small decrease in bandwith using the Sheather-Jones method, our density now contains two local minima. Given the slight change and the results of our k-means tests for determining k, it seems reasonable to relax some degree of smoothness in favour of more variability.

```{r}
# generate kde with reduced bw
minima <- kde.rbw$x[tp.rbw$pits]
minima
```
The density estimations suggests that we can divide countries into three groups:

1. low inequality ($0 < gii \leq 0.2395$)
1. medium inequality ($0.2395 < gii \leq 0.3773$)
1. high inequality ($0.3773 < gii \leq 0.8$)

## Comparing K-Means with KDE

```{r}
# get names func
get.rnames <- function(df){
  df %>%
    rownames %>%
    sort
}

# kde groups
low_kde <- get.rnames(gender[which(gender$GII.val<=minima[1]),])
med_kde <- get.rnames(gender[which(
  gender$GII.val<=minima[2]&gender$GII.val>minima[1]),])
hi_kde <- get.rnames(gender[which(gender$GII.val>minima[2]),])

# km clusters
low_km <- sort(names(km$cluster[km$cluster==2]))
med_km <- sort(names(km$cluster[km$cluster==1]))
hi_km <- sort(names(km$cluster[km$cluster==3]))

# pad with whitespace
paddr <- function(kde,km){
  inter <- kde[kde %in% km]
  kde <- kde[!kde %in% km]
  km <- km[!km %in% inter]
  max.len <- max(length(kde),length(km),length(inter))
  kde <- c(kde, rep(" ", max.len - length(kde)))  
  km <- c(km, rep(" ", max.len - length(km)))
  inter <- c(inter, rep(" ", max.len - length(inter)))
  data.frame(Both=inter, KDE_only=kde, Kmeans_only=km)
}

```

### Low Inequality

```{r echo=FALSE, results='asis'}

lowgrp <- paddr(low_kde, low_km)
knitr::kable(lowgrp, format = "html")
```

### Medium Inequality

```{r echo=FALSE, results='asis'}

medgrp <- paddr(med_kde, med_km)
knitr::kable(medgrp, format = "html")
```

### High Inequality

```{r echo=FALSE, results='asis'}

higrp <- paddr(hi_kde, hi_km)
knitr::kable(higrp, format = "html")
```

The results show a degree of difference in the grouping of countries (although the (inferred) ranking of countries in the two extreme groups of the k-means clusters appears to be somewhat similar to the KDE for many countries).

## Hierarchical Clustering

Finally, we can compare these groupings to a dendrogram which clusters countries hierarchically, starting with each country and pairing it with its most similar neighbour.

```{r}
# order alphabetically
gender.scaled <- gender.scaled[order(row.names(gender.scaled)), ]

# create a dendrogram
hc <- hclust(dist(gender.scaled))
dend <- as.dendrogram(hc)

# modify the dendrogram to have some colors in the branches and labels
dend <- dend %>% 
   color_branches(k=10) %>% 
   color_labels(k=10)

# plot the radial plot
par(cex = 0.6, mar = rep(0,4))
circlize_dendrogram(dend, edgePar=list(cex=0.3)) 
```

These results appear a bit more similar to the k-means clusters than to the KDE groups.